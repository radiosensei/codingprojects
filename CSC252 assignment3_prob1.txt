#include <iostream>
#include <vector>
#include <string>
#include <memory>
#include <sstream>
#include <iomanip>
#include <limits>
using namespace std;

// ---------------------- Date Class ----------------------
class Date {
public:
    int year, month, day;

    Date(int y, int m, int d) : year(y), month(m), day(d) {}

    string ToString() const {
        ostringstream oss;
        oss << setfill('0') << setw(4) << year << "-"
            << setw(2) << month << "-"
            << setw(2) << day;
        return oss.str();
    }
};

// ---------------------- Date Validation ----------------------
bool is_leap_year(int year) {
    return (year % 4 == 0 && year % 100 != 0) || (year % 400 == 0);
}

bool is_valid_date(int year, int month, int day) {
    if (year < 1000 || month < 1 || month > 12 || day < 1)
        return false;

    int days_in_month[] = { 31, 28, 31, 30, 31, 30,
                            31, 31, 30, 31, 30, 31 };

    if (month == 2 && is_leap_year(year))
        return day <= 29;

    return day <= days_in_month[month - 1];
}

// ------------------ Appointment Base Class ------------------
class Appointment {
protected:
    string description;
    Date date;

public:
    Appointment(string desc, Date d) : description(desc), date(d) {}

    virtual bool occurs_on(int year, int month, int day) const = 0;

    virtual string ToString() const {
        return description + " on " + date.ToString();
    }

    virtual ~Appointment() = default;
};

// ------------------ Day Appointment Class ------------------
class Day : public Appointment {
public:
    Day(string desc, Date d) : Appointment(desc, d) {}

    bool occurs_on(int year, int month, int day) const override {
        return date.year == year && date.month == month && date.day == day;
    }
};

// ------------------ Monthly Appointment Class ------------------
class Monthly : public Appointment {
public:
    Monthly(string desc, Date d) : Appointment(desc, d) {}

    bool occurs_on(int year, int month, int day) const override {
        return date.year == year && date.day == day;
    }
};

// ---------------------- Get Validated Date Input ----------------------
bool get_valid_date_input(int& year, int& month, int& day) {
    string input;
    while (true) {
        cout << "Enter a date (YYYY MM DD) with spaces: ";
        getline(cin, input);
        stringstream ss(input);

        if (!(ss >> year >> month >> day)) {
            cout << "❌ Wrong input format. Please use: YYYY MM DD (e.g., 2025 07 10)\n";
            continue;
        }

        string extra;
        if (ss >> extra) {
            cout << "❌ Too many values. Only enter 3 numbers.\n";
            continue;
        }

        if (!is_valid_date(year, month, day)) {
            cout << "❌ Invalid calendar date. Try again.\n";
            continue;
        }

        return true;
    }
}

// ------------------------- Main Function -------------------------
int main() {
    vector<shared_ptr<Appointment>> appointments;

    // Create mixed appointments
    appointments.push_back(make_shared<Day>("Doctor visit", Date(2025, 7, 10)));
    appointments.push_back(make_shared<Monthly>("Credit card payment", Date(2025, 1, 15)));
    appointments.push_back(make_shared<Day>("Project deadline", Date(2025, 7, 20)));
    appointments.push_back(make_shared<Monthly>("Team sync meeting", Date(2025, 1, 10)));

    // Get validated input
    int y, m, d;
    get_valid_date_input(y, m, d);

    // Show matching appointments
    cout << "\nAppointments on "
         << setfill('0') << setw(4) << y << "-"
         << setw(2) << m << "-" << setw(2) << d << ":\n";

    bool found = false;
    for (const auto& appt : appointments) {
        if (appt->occurs_on(y, m, d)) {
            cout << "- " << appt->ToString() << endl;
            found = true;
        }
    }

    if (!found) {
        cout << "No appointments found on that date.\n";
    }

    return 0;
}
